#!/bin/bash
git checkout develop && \
  git pull && \
  git checkout master && \
  git pull || exit 1

NEW_VERSION=$(cat version.txt | perl -pe 's/^([0-9]+)\.([0-9]+)\.([0-9]+).*/"$1.$2.".(int($3)+1)/e')
echo "Releasing $NEW_VERSION (last release was `cat version.txt`)"


git flow release start "$NEW_VERSION" && \
  echo "$NEW_VERSION" > version.txt && \
  git add version.txt && \
  git commit -m "version bump to $NEW_VERSION" && \
  git flow release finish "$NEW_VERSION" && \
  git push && \
  git push --tags && \
  git checkout develop