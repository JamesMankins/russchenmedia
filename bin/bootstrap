#!/bin/bash
set -e

bundle

type brew && brew install postgres
echo INIT DB:
initdb './tmp/postgres' -E utf8 --locale en_US.utf8  || echo "database already exists (?), ignoring."

# allow socket access from usermode:
# For full WTF-ness; read: http://postgresql.1045698.n5.nabble.com/Add-socket-dir-to-pg-config-td4944750.html

if [ ! -d '/var/pgsql_socket/' ]; then
  #for Mac OSX
  sudo mkdir -p /var/pgsql_socket/
  sudo chmod a+w /var/pgsql_socket/
fi
if [ ! -d '/var/run/postgresql/' ]; then
  #for Ubuntu

  sudo mkdir -p  /var/run/postgresql/
  sudo chmod a+w /var/run/postgresql/
fi

# run postgres for setup
echo START DB:
postgres -D 'tmp/postgres'  &
POSTGRES_PID=$!

# create test and development databases
bundle exec rake db:setup
bundle exec rake db:test:prepare

# kill postgres
kill $POSTGRES_PID

#wait for postgres to exit
wait
